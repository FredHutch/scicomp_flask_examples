<!DOCTYPE html>
<html>
<head>
<title>Storage Hotspot Finder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.5.4/jquery.timeago.js"></script>

</head>
<body>
    <div class="navbar">
        <div class="navbar-inner">
            <a class="brand" href="#">Storage Hotspots</a>
        </div>
    </div>
    <div id="main" class="container">
      PI: <select data-bind="value: pi, event: { change: piChanged }" >
        {% for item in pi_list %}
           <option value="{{item}}">{{item}}</option>
        {% endfor %}
      </select>

      Show only folders larger than
      <input name="size_threshold" data-bind="textInput: foldersize" type="number" size="4"/> GB
      <br/>size is:<p data-bind="text: foldersize"></p>

      <button data-bind="enable: page() >= 2, click: decrementPageCount" class="prevbutton">Previous</button>
      <button data-bind="click: incrementPageCount" class="nextbutton">Next</button>

      Current page: <span data-bind="text: page"></span>

      <br/>

        <table>
            <thead><tr>
                <th>Owner</th><th>Name</th><th>Filename</th><th>mtime</th><th>GB</th>
            </tr></thead>
            <tbody data-bind="foreach: rows">
                <tr>
                    <td data-bind="text: owner"></td>
                    <td data-bind="text: name"></td>
                    <td data-bind="text: filename"></td>
                    <td><time data-bind="attr: {datetime: mtime}" class="timeago" datetime=""></time></td>
                    <td data-bind="text: gb"></td>
                </tr>
            </tbody>        </table>

<br/>
<button data-bind="enable: page() >= 2, click: decrementPageCount" class="prevbutton">Previous</button>
<button data-bind="click: incrementPageCount" class="nextbutton">Next</button>



    </div>
    <script type="text/javascript">

        // application code here!

        // Class to represent a row in the seat reservations grid
        function Row(stuff) {
            var self = this;
            self.owner = stuff[0];
            self.name = stuff[1];
            self.filename = stuff[2];
            self.mtime = stuff[3];
            self.gb = stuff[4];
        }

        // Overall viewmodel for this screen, along with initial state
        function MyViewModel() {
            var self = this;

            // Non-editable catalog data - would come from the server
            // self.availableMeals = [
            //     { mealName: "Standard (sandwich)", price: 0 },
            //     { mealName: "Premium (lobster)", price: 34.95 },
            //     { mealName: "Ultimate (whole zebra)", price: 290 }
            // ];

            // Editable data
            // self.rows = ko.observableArray([
            //     new Row("nelson_p", "ndesarka", "/fh/fast/foo", "1/2/3", 6467.11),
            //     new Row("christ_j", "satan", "/fh/fast/bar", "1/2/4", 666.666),
            //     new Row("bla_b", "hell", "/fh/fast/baz", "1/2/5", 123.456)
            // ]);
            self.rows = ko.observableArray([]);
            self.foldersize = ko.observable(10);
            self.offset = ko.observable(0);
            self.pi = ko.observable('None');
            // self.pi = ko.observable('peters_u');
            self.rows_per_page = ko.observable(15);
            self.page = ko.observable(1);


            decrementPageCount = function() {
              var previousCount = self.page();
              self.page(--previousCount);
              self.offset((self.page()-1) * self.rows_per_page())
              updateModel(false);
            }

            incrementPageCount = function() {
              var previousCount = self.page();
              self.page(++previousCount);
              self.offset((self.page()-1) * self.rows_per_page())
              updateModel(false);
            }

            piChanged = function(data) {
              console.log("PI CHANGED!, new PI is " + data.pi());
              updateModel(true);
            }

            this.foldersize.subscribe(function(newValue) {
              console.log("SIZE CHANGED!, new size is " + newValue);
              updateModel(true);
            })

            updateModel = function(startFromFirstPage) {
              console.log("in updateModel");
              if (startFromFirstPage) {
                self.page(1);
                self.offset(0);
                updateModel(false);
              }


              $.ajax({url: "/query",
                      data: {pi: self.pi(), foldersize: self.foldersize(),
                            rows_per_page: self.rows_per_page(), offset: self.offset()},
                      success: function(response) {
                        var mappedRows = $.map(response,
                          function(item) {
                            return new Row(item);
                          });
                          self.rows(mappedRows);
                          jQuery(document).ready(function() {
                            jQuery("time.timeago").timeago();
                          });

                      },
                      error: function(xhr) {console.log("ajax error: " +  xhr)}});
                  }

          updateModel(false);

        }
        ko.applyBindings(new MyViewModel());

    </script>
</body>
</html>
